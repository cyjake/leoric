---
layout: zh
title: 2022.02 v2.2
---

å› ä¸ºæ˜¥èŠ‚é•¿å‡çš„å…³ç³»ï¼Œä»¥åŠéƒ¨åˆ†ç ”å‘æ—¶é—´æŠ•å…¥åœ¨ [Porter](https://github.com/porterhq/porter) é¡¹ç›®ï¼ŒLeoric çš„ä¸€æœˆæ›´æ–°æ—¥å¿—è·³ç¥¨åˆ°äº†äºŒæœˆã€‚ Leoric çš„åŠŸèƒ½è¿­ä»£ä»ç„¶åœ¨ç´§é”£å¯†é¼“è¿›è¡Œä¸­ï¼Œè¿‡å»ä¸¤ä¸ªæœˆçš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨å­—æ®µç±»å‹å¢å¼ºã€æ ¡éªŒåŠŸèƒ½å®Œå–„ã€ä»¥åŠå…¼å®¹æ›´å¤šå¸¸ç”¨çš„ MySQL ç‰¹æ€§ä¸Šé¢ã€‚

äºŒæœˆä»½ Leoric è¿æ¥ä¸¤ä½æ–°çš„è´¡çŒ®è€… ğŸ‘ğŸ‘ [@LB4027221](https://github.com/LB4027221) å’Œ [@luckydrq](https://github.com/luckydrq)

## å­—æ®µç±»å‹å¢å¼º

### TINYINTã€SMALLINTã€etc.

v2.2.x å¢åŠ æ›´å¤šå…·ä½“ç±»å‹ï¼Œä¾‹å¦‚ MySQL ä¸­å¯èƒ½ç”¨åˆ°çš„ TINYINTã€SMALLINTã€æˆ–è€… MEDIUMINTã€‚è¿™äº›ç±»å‹åœ¨ SQLite ä¸­åä¹‰ä¸Šä¹Ÿæ”¯æŒï¼Œåœ¨ PostgreSQL åˆ™åªæœ‰ SMALLINTï¼Œæˆ‘ä»¬åœ¨ç›¸åº”çš„æ•°æ®åº“é©±åŠ¨ä¸­å‡åšäº†å…¼å®¹ã€‚ä½¿ç”¨æ–¹å¼å’Œå…¶ä»–å¸¸è§ç±»å‹ä¸€è‡´ï¼š

```typescript
import { Bone, DataTypes } from 'leoric';

const { TINYINT, SMALLINT, BIGINT } = DataTypes;

export class User extends Bone {
  static attributes = {
    id: BIGINT,
    age: SMALLINT,
    sex: TINYINT(1),
  }
}
```

å¯¹äº ActiveRecord é£æ ¼çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™æ¬¡å¢åŠ çš„å…·ä½“ç±»å‹ä¹Ÿå¯ä»¥è‡ªåŠ¨æ˜ å°„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ users è¡¨çš„ DDL å¦‚ä¸‹ï¼š

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  age SMALLINT DEFAULT 0 NOT NULL,
  sex TINYINT(1) NOT NULL,
);
```

Leoric ä»ä¸Šè¿°è¡¨ç»“æ„åˆå§‹åŒ– User æ•°æ®æ¨¡å‹æ—¶ï¼Œå¯¹åº”çš„å±æ€§å®šä¹‰ä¹Ÿä¼šæ˜¯å…·ä½“çš„ç±»å‹ï¼š

```javascript
class User extends Bone {};
await connect({ database: 'foo', models: [ User ] });
assert.equal(User.attributes.sex.type.toSqlString(), 'TINYINT(1)');
```

## æ ¡éªŒåŠŸèƒ½ & ç¼ºçœå€¼

### Validations

[https://github.com/cyjake/leoric/pull/266](https://github.com/cyjake/leoric/pull/266)

| **DB/DataType (validate or not in SQL operations)** | **INTEGER** | **DATE** |
| --- | --- | --- |
| MySQL | ğŸ”²query âœ…insert | âœ…query âœ…insert |
| SQLlite | ğŸ”²query ğŸ”²insert | ğŸ”²query ğŸ”²insert |
| PostgresSQL | âœ…query âœ…insert | âœ…query âœ…insert |

æˆ‘ä»¬åœ¨ v2.0.2 ç‰ˆæœ¬ä¸­å¢å¼ºäº†æ ¡éªŒé€»è¾‘ï¼Œå°†æŒ‰ç…§æ‰€ä½¿ç”¨çš„æ•°æ®åº“æ ¡éªŒé€»è¾‘æå‰æ ¡éªŒç›¸å…³æ“ä½œï¼Œä¾‹å¦‚åœ¨ MySQL ä¸­ï¼Œå¦‚ä¸‹ SQL éƒ½å°†è§¦å‘å¼‚å¸¸ï¼š

```sql
mysql> SELECT now() = '2022-13-12';
ERROR 1525 (HY000): Incorrect DATETIME value: '2022-13-12'
mysql> SELECT * FROM articles WHERE gmt_create >= '2022-13-12';
ERROR 1525 (HY000): Incorrect TIMESTAMP value: '2022-13-12'
mysql> INSERT INTO articles (gmt_create) VALUES ('2022-13-12');
ERROR 1292 (22007): Incorrect datetime value: '2022-13-12' for column 'gmt_create' at row 1
```

v2.0.2 å°†ç›¸å…³æ ¡éªŒé€»è¾‘æå‰ï¼Œä¾¿äºå°½æ—©å‘ç°é—®é¢˜ã€‚

### DEFAULT VALUE

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ•°æ®æ¨¡å‹æ²¡æœ‰å®šä¹‰ `Model.attributes`ï¼Œç”± Leoric åœ¨å¯åŠ¨æ—¶ä»æ•°æ®åº“åˆå§‹åŒ–å­—æ®µä¿¡æ¯æ—¶ï¼ŒLeoric ä¸ä¼šè®¾ç½®å­—æ®µçš„ç¼ºçœå€¼ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ç”Ÿæˆçš„æ’å…¥ã€æ›´æ–° SQL å¯ä»¥åœ¨æ•°æ®åº“æ‰§è¡Œæ—¶å†è¡¥å……å‰©ä½™ä¿¡æ¯ï¼Œä½†åå¤„æ˜¯å¦‚æœé‡åˆ°ä¸‹é¢è¿™ç§è¡¨ï¼š

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  level INTEGER DEFAULT VALUE 0 NOT NULL
);
```

ç„¶å User æ•°æ®æ¨¡å‹ä¸­æ²¡æœ‰ä¸“é—¨å£°æ˜å­—æ®µä¿¡æ¯ï¼š

```javascript
class User extends Bone {}
const user = new User();
assert.equal(user.level, 0);  // user.level -> null
```
v2.0.4 ä¿®å¤äº†è¿™ä¸€é—®é¢˜ï¼Œåœ¨åº”ç”¨ä¾§ä¹Ÿå°†è¯»å–åˆ°æ­£ç¡®çš„ç¼ºçœå€¼ã€‚

## é—®é¢˜ä¿®å¤

### UPDATE ... ORDER ... LIMIT

MySQL æ”¯æŒ `UPDATE ... ORDER ... LIMIT` æˆ–è€… `DELETE ... ORDER ... LIMIT` ç­‰æ“ä½œï¼Œåœ¨ Leoric v2.x ä¹‹å‰çš„ç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰å®Œæ•´æ”¯æŒè¿™ä¸€ç‰¹æ€§ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ç§ä»£ç ï¼š
```javascript
await User
  .where({ status: STATUS_BLOCKED })
  .update({ nickname: '*blocked*' })
  .order('id', 'desc')
  .limit(10);
// æ›´æ–°æœ€è¿‘åä¸ªè¢«å±è”½ç”¨æˆ·çš„æ˜µç§°
```
åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¼šæ¼æ‰ ORDER å’Œ LIMIT éƒ¨åˆ†ï¼Œ[v2.0.2](https://github.com/cyjake/leoric/releases/tag/v2.0.2) ç‰ˆæœ¬ä¿®å¤äº†è¿™ä¸€é—®é¢˜ï¼›[v2.1.0](https://github.com/cyjake/leoric/releases/tag/v2.1.0) åˆ™ä¿®å¤äº† DELETE çš„å¯¹åº”é€»è¾‘ã€‚ç»™ UPDATE å’Œ DELETE æ’åºæˆ–è€…é™å®šæ¡æ•°æ˜¯ MySQL ç‰¹æ€§ï¼ŒPostgreSQL æˆ–è€… SQLite å‡ä¸æ”¯æŒã€‚

### ORDER BY alias

v2.0.2 ä¿®å¤èšåˆæŸ¥è¯¢æ’åºæ—¶ç”¨åˆ°åˆ«åä¼šæŠ¥é”™çš„é—®é¢˜ï¼Œç±»ä¼¼å¦‚ä¸‹ç”¨æ³•ï¼š

```javascript
await User.count().group('sex').having('count > 0').order('count', 'desc');
```

å¦‚æœä½¿ç”¨ Sequelize å†™æ³•ï¼Œå¤§è‡´æ˜¯ï¼š

```javascript
await User.find({
  attributes: sequelize.fn('COUNT', '*'),
  group: 'sex',
  having: {
    count: { $gt: 0 },
  },
  order: [[ 'count', 'desc' ]],
});
```

### UPSERT æ—¶è®¾ç½® createdAt é»˜è®¤å€¼

ä¹‹å‰ç‰ˆæœ¬çš„ upsert åœ¨æ‰§è¡Œæ—¶ä¸ä¼šé»˜è®¤æ’å…¥ createdAtï¼š
```javascript
Post.upsert({ title: 'yes' });
```

æ›´æ–°ä¹‹å‰ç”Ÿæˆçš„ SQL:

```sql
INSERT INTO `posts`
  (`title`, `updated_at`)
VALUES
  ('yes', `CURRENTTIME`)
ON DUPLICATE KEY UPDATE
`title` = VALUES(`title`),
`updated_at` = VALUES(`updated_at`)
```

è¿™ä¼šå¯¼è‡´ upsert æ’å…¥æ–°æ•°æ®æ—¶ä¼šå¯èƒ½ä¸ä¼šæ’å…¥ createdAtï¼Œå¯¼è‡´å­—æ®µç¼ºå¤±æˆ–è€…æ•°æ®åº“æŠ¥é”™<br />ä¿®å¤åç”Ÿæˆ SQL ä¸º:

```sql
INSERT INTO `posts`
  (`title`, `created_at`, `updated_at`)
VALUES
  ('yes', `CURRENTTIME`, `CURRENTTIME`)
ON DUPLICATE KEY UPDATE
`title` = VALUES(`title`),
`updated_at` = VALUES(`updated_at`)
```

## ç±»å‹è¡¥å……

### Realm ç±»å‹è¡¥å……

v2.1.1 å’Œ v2.2.0 åˆ†åˆ«å®Œå–„äº† `new Realm()`ã€`realm.connect()`ã€`realm.define()`ç­‰æ–¹æ³•çš„ç±»å‹å®šä¹‰ï¼Œä½†é¢„è®¡ä»ç„¶æœ‰è®¸å¤šå…¶ä»–é—®é¢˜ï¼Œå¯¹äºä½¿ç”¨ TypeScript ç¼–å†™ Egg åº”ç”¨çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬æ¨èå‚è€ƒ [cnpm/cnpmcore](https://github.com/cnpm/cnpmcore) æˆ–è€… [eggjs/egg-orm!examples/typescript](https://github.com/eggjs/egg-orm/tree/master/examples/typescript)

### [wip] è£…é¥°å™¨

Leoric çš„ç±»å‹å®šä¹‰è¿˜è¿œæœªå®Œå–„ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ•°æ®æ¨¡å‹çš„ç±»å‹å£°æ˜ï¼Œæˆ‘ä»¬æ­£åœ¨å°è¯•ä½¿ç”¨è£…é¥°å™¨æ¥ç®€åŒ–ç›¸å…³é…ç½®ï¼Œç›®å‰å¤§è‡´æ€è·¯æ˜¯é€šè¿‡ class property é…åˆ `@Column` è£…é¥°å™¨å®Œæˆ `Model.attributes` é…ç½®ï¼š

```typescript
import { DataTypes } from 'leoric';

const { MEDIUMINT } = DataTypes;

class Post extends Bone {
  @Column()
  id: bigint;

  @Column({ name: 'gmt_create' })
  createdAt: Date;

  @Column({ name: 'gmt_modified'})
  updatedAt: Date;

  @Column({ name: 'gmt_deleted' })
  deletedAt: Date;

  @Column(MEDIUMINT)
  wordCount: number;
}
```
